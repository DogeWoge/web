#!/usr/bin/env python

import os
import shutil
import sys

import git
import urllib


REPO_ROOT = '/home/eyqs/Downloads/Dropbox/Projects/web/'
REPO_REMOTE = 'origin'
BUILD_BRANCH = 'gh-pages'
BUILD_FOLDER = '_site/'
BUILD_PATH = os.path.join(REPO_ROOT, BUILD_FOLDER)

IGNORED_FILES = ['.git', '.gitignore', '.gitmodules',
        '_includes', '_layouts', '_pages', '_posts', '_redirects',
        'LICENSE.md', 'README.md', 'requirements.txt', 'web']



def archive():

    pages = ['', 'about/', 'blog/', 'cakes/', 'documents/', 'projects/',
             'questions/', 'resume/', 'sitemap/', 'tools/']

    posts = ['1804-ubcs-cpen/', '1805-late-rides/', '1806-wtfjs-idkjs/',
             '1807-cloud-next/', '1808-sunny-vale/', '1809-mug-share/',
             '1811-music-18w1/', '1901-new-year/', '1902-wand-earth/']

    for page in pages:
        print(f'Archiving page: {page}')
        urllib.request.urlopen(
                f'http://web.archive.org/save/https://eyqs.ca/{page}')

    for post in posts:
        print(f'Archiving post: {post}')
        urllib.request.urlopen(
                f'http://web.archive.org/save/https://eyqs.ca/blogs/{post}')


def push():

    repo = git.Repo(REPO_ROOT)
    repo.git.subtree('push', REPO_REMOTE, BUILD_BRANCH, prefix=BUILD_FOLDER)


def build():

    if os.path.exists(BUILD_PATH):
        print(f'Removing build directory: {BUILD_FOLDER}')
        shutil.rmtree(BUILD_PATH)

    with os.scandir(REPO_ROOT) as it:
        for entry in it:
            if entry.name not in IGNORED_FILES:
                dest_path = os.path.join(BUILD_PATH, entry.name)
                if entry.is_dir():
                    print(f'Copying folder: {entry.name}/')
                    shutil.copytree(entry.path, dest_path)
                else:
                    print(f'Copying page: {entry.name}')
                    shutil.copy(entry.path, dest_path)



if __name__ == '__main__':

    if len(sys.argv) != 2:
        print('Usage: ./web [archive|build|push]')
        exit(1)

    os.chdir(REPO_ROOT)
    if sys.argv[1] == 'archive':
        archive()
    elif sys.argv[1] == 'build':
        build()
    elif sys.argv[1] == 'push':
        push()
    else:
        print('Usage: ./web [archive|build|push]')
        exit(1)
