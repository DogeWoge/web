#!/usr/bin/env python

import os
import shutil
import sys

import git
import urllib


REPO_REMOTE = 'origin'
BUILD_BRANCH = 'gh-pages'
BUILD_FOLDER = '_site'
PAGES_FOLDER = '_pages'
POSTS_FOLDER = '_posts'
BLOGS_FOLDER = 'blogs'
REDIRECTS_FOLDER = '_redirects'

REPO_ROOT = '/home/eyqs/Downloads/Dropbox/Projects/web/'
BUILD_PATH = os.path.join(REPO_ROOT, BUILD_FOLDER)
PAGES_PATH = os.path.join(REPO_ROOT, PAGES_FOLDER)
POSTS_PATH = os.path.join(REPO_ROOT, POSTS_FOLDER)
BLOGS_PATH = os.path.join(BUILD_PATH, BLOGS_FOLDER)
REDIRECTS_PATH = os.path.join(REPO_ROOT, REDIRECTS_FOLDER)

IGNORED_FILES = [PAGES_FOLDER, POSTS_FOLDER, REDIRECTS_FOLDER,
        '.git', '.gitmodules', '_includes', '_layouts',
        'LICENSE.md', 'README.md', 'requirements.txt', 'web']



def name_to_url(name):
    return os.path.splitext(name)[0]


def archive():

    print('Archiving index')
    urllib.request.urlopen('http://web.archive.org/save/https://eyqs.ca/')

    with os.scandir(PAGES_PATH) as it:
        for entry in it:
            page = name_to_url(entry.name)
            print(f'Archiving page: {page}')
            urllib.request.urlopen(
                    f'http://web.archive.org/save/https://eyqs.ca/{page}/')

    with os.scandir(POSTS_PATH) as it:
        for entry in it:
            p = name_to_url(entry.name)
            print(f'Archiving post: {p}')
            urllib.request.urlopen(
                    f'http://web.archive.org/save/https://eyqs.ca/blogs/{p}/')


def push():

    repo = git.Repo(REPO_ROOT)
    repo.git.subtree('push', REPO_REMOTE, BUILD_BRANCH, prefix=BUILD_FOLDER)


def build():

    if os.path.exists(BUILD_PATH):
        print(f'Removing build directory: {BUILD_FOLDER}/')
        shutil.rmtree(BUILD_PATH)

    with os.scandir(REPO_ROOT) as it:
        for entry in it:
            if entry.name not in IGNORED_FILES:
                dest_path = os.path.join(BUILD_PATH, entry.name)
                if entry.is_dir():
                    print(f'Copying folder: {entry.name}/')
                    shutil.copytree(entry.path, dest_path)
                else:
                    print(f'Copying page: {entry.name}')
                    shutil.copy(entry.path, dest_path)

    with os.scandir(PAGES_PATH) as it:
        for entry in it:
            print(f'Copying page: {entry.name}')
            folder = os.path.join(BUILD_PATH, name_to_url(entry.name))
            os.mkdir(folder)
            shutil.copy(entry.path, os.path.join(folder, 'index.html'))

    os.mkdir(BLOGS_PATH)
    with os.scandir(POSTS_PATH) as it:
        for entry in it:
            print(f'Copying post: {entry.name}')
            folder = os.path.join(BLOGS_PATH, name_to_url(entry.name))
            os.mkdir(folder)
            shutil.copy(entry.path, os.path.join(folder, 'index.html'))

    with os.scandir(REDIRECTS_PATH) as it:
        for entry in it:
            print(f'Copying redirect: {entry.name}')
            folder = os.path.join(BUILD_PATH, name_to_url(entry.name))
            os.mkdir(folder)
            shutil.copy(entry.path, os.path.join(folder, 'index.html'))



if __name__ == '__main__':

    if len(sys.argv) != 2:
        print('Usage: ./web [archive|build|push]')
        exit(1)

    os.chdir(REPO_ROOT)
    if sys.argv[1] == 'archive':
        archive()
    elif sys.argv[1] == 'build':
        build()
    elif sys.argv[1] == 'push':
        push()
    else:
        print('Usage: ./web [archive|build|push]')
        exit(1)
