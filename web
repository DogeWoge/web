#!/usr/bin/env python

import os
import shutil
import sys

import git
import urllib


SITE_URL = 'https://eyqs.ca'
REPO_REMOTE = 'origin'
BUILD_BRANCH = 'gh-pages'

REPO_ROOT = '/home/eyqs/Downloads/Dropbox/Projects/web/'
POSTS_FOLDER = '_posts'
LAYOUTS_FOLDER = '_layouts'
INCLUDES_FOLDER = '_includes'
BUILD_FOLDER = '_site'
BLOGS_FOLDER = 'blogs'
BUILD_PATH = os.path.join(REPO_ROOT, BUILD_FOLDER)

IGNORED_FILES = ['.git', '.gitmodules',
        'LICENSE.md', 'README.md', 'requirements.txt', 'web',
        POSTS_FOLDER, LAYOUTS_FOLDER, INCLUDES_FOLDER, BUILD_FOLDER]
UNARCHIVED_FILES = ['index.html', '404.html']
CONTENT_EXTENSIONS = ['.html', '.md']



def get_name(name):
    return os.path.splitext(name)[0]


def get_extension(name):
    return os.path.splitext(name)[1]


def is_content(name):
    return get_extension(name) in CONTENT_EXTENSIONS


def archive():

    print('Archiving index')
    urllib.request.urlopen(f'http://web.archive.org/save/{SITE_URL}')

    with os.scandir(REPO_ROOT) as it:
        for entry in it:
            if entry.name in UNARCHIVED_FILES:
                continue
            if get_extension(entry.name) == '.html':
                page = get_name(entry.name)
                print(f'Archiving page: {page}')
                urllib.request.urlopen('http://web.archive.org/'
                        + f'save/{SITE_URL}/{page}/')

    with os.scandir(os.path.join(REPO_ROOT, POSTS_FOLDER)) as it:
        for entry in it:
            post = get_name(entry.name)
            print(f'Archiving post: {post}')
            urllib.request.urlopen('http://web.archive.org/'
                    + f'save/{SITE_URL}/{BLOGS_FOLDER}/{post}/')


def push():

    repo = git.Repo(REPO_ROOT)
    repo.git.subtree('push', REPO_REMOTE, BUILD_BRANCH, prefix=BUILD_FOLDER)


def build():

    if os.path.exists(BUILD_PATH):
        print(f'Removing build directory: {BUILD_FOLDER}/')
        shutil.rmtree(BUILD_PATH)

    os.mkdir(BUILD_PATH)
    with os.scandir(REPO_ROOT) as it:
        for entry in it:
            if entry.name not in IGNORED_FILES:
                if is_content(entry.name):
                    dest_path = os.path.join(
                            BUILD_PATH, f'{get_name(entry.name)}.html')
                    print(f'Generating page: {entry.name}')
                    shutil.copy(entry.path, dest_path)
                else:
                    dest_path = os.path.join(BUILD_PATH, entry.name)
                    if entry.is_dir():
                        print(f'Copying folder: {entry.name}/')
                        shutil.copytree(entry.path, dest_path)
                    else:
                        print(f'Copying file: {entry.name}')
                        shutil.copy(entry.path, dest_path)

    os.mkdir(os.path.join(BUILD_PATH, BLOGS_FOLDER))
    with os.scandir(os.path.join(REPO_ROOT, POSTS_FOLDER)) as it:
        for entry in it:
            print(f'Generating post: {entry.name}')
            dest_path = os.path.join(
                    BUILD_PATH, BLOGS_FOLDER, f'{get_name(entry.name)}.html')
            shutil.copy(entry.path, dest_path)



if __name__ == '__main__':

    if len(sys.argv) != 2:
        print('Usage: ./web [archive|build|push]')
        exit(1)

    os.chdir(REPO_ROOT)
    if sys.argv[1] == 'archive':
        archive()
    elif sys.argv[1] == 'build':
        build()
    elif sys.argv[1] == 'push':
        push()
    else:
        print('Usage: ./web [archive|build|push]')
        exit(1)
